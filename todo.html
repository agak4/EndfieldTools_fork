<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì—”ë“œí•„ë“œ ìˆ™ì œ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        
        /* ì²´í¬ë°•ìŠ¤ ì»¤ìŠ¤í…€ */
        .task-checkbox:checked + div { background-color: #10b981; border-color: #10b981; }
        .task-checkbox:checked + div svg { display: block; }
        
        /* ì™„ë£Œ ìƒíƒœ */
        .task-item.completed .glass-panel { background: rgba(15, 23, 42, 0.6); }
        .task-item.completed .task-content { opacity: 0.5; text-decoration: line-through; color: #94a3b8; }
        
        /* ë“œë˜ê·¸ í•¸ë“¤ ìŠ¤íƒ€ì¼ */
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; color: #34d399; }
        
        /* ë“œë˜ê·¸ ì¤‘ì¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .sortable-ghost { opacity: 0.3; background: #334155; border-radius: 1rem; }
        .sortable-fallback { opacity: 1 !important; transform: scale(1.02); z-index: 9999; pointer-events: none; }
        .sortable-fallback .glass-panel { background: #1e293b; border-color: #10b981; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5); }

        .progress-bar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 via-slate-950 to-black selection:bg-blue-500 selection:text-white relative text-base">
    
    <nav class="flex justify-center gap-2 p-4 bg-slate-900/50 backdrop-blur-md border-b border-white/5 sticky top-0 z-50">
        <a href="index.html" class="px-6 py-3 rounded-xl text-base font-bold transition-all bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white">
            ğŸ§® ê¸°ì§ˆ ê³„ì‚°ê¸°
        </a>
        <a href="todo.html" class="px-6 py-3 rounded-xl text-base font-bold transition-all bg-emerald-600 text-white shadow-lg scale-105">
            ğŸ“ ìˆ™ì œ ê´€ë¦¬
        </a>
    </nav>

    <div class="max-w-3xl mx-auto space-y-6 pb-24 mt-6 px-4 md:px-8">
        
        <section class="sticky top-24 z-40 drop-shadow-2xl transition-all duration-300">
            <div class="glass-panel rounded-3xl p-6 relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                            <span class="w-2 h-6 bg-emerald-500 rounded-full"></span> ì¼ì¼ ì—…ë¬´ ë³´ê³ 
                        </h2>
                        <p class="text-sm text-slate-400 mt-1">ë§¤ì¼ ìƒˆë²½ 5ì‹œ ì´ˆê¸°í™”</p>
                    </div>
                    <span class="text-4xl font-black text-emerald-400"><span id="progress-text">0</span>%</span>
                </div>
                
                <div class="w-full bg-slate-700/50 rounded-full h-4 overflow-hidden mb-5">
                    <div id="progress-bar" class="progress-bar bg-gradient-to-r from-emerald-500 to-cyan-500 h-4 rounded-full w-0 shadow-[0_0_10px_#10b981]"></div>
                </div>
                
                <div class="flex justify-between items-end border-t border-white/10 pt-4">
                    <p class="text-xs text-slate-500 mb-1" id="last-reset-time">ë¡œë”© ì¤‘...</p>
                    <div class="flex gap-2">
                        <button onclick="taskManager.resetOrder()" class="px-4 py-2.5 rounded-xl bg-slate-800 text-sm font-bold text-slate-300 border border-slate-600 hover:bg-slate-700 hover:text-white transition-colors">
                            â†º ìˆœì„œ ì´ˆê¸°í™”
                        </button>
                        <button onclick="taskManager.forceReset()" class="px-4 py-2.5 rounded-xl bg-slate-800 text-sm font-bold text-red-400 border border-slate-600 hover:bg-slate-700 hover:text-red-300 transition-colors">
                            âœ– ì§„í–‰ ë¦¬ì…‹
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div class="flex gap-4 border-b border-slate-700/50 pb-1">
            <button onclick="taskManager.switchTab('daily')" id="tab-daily" class="px-4 py-2 text-base font-bold text-emerald-400 border-b-2 border-emerald-500 transition-colors">Daily</button>
            <button onclick="taskManager.switchTab('weekly')" id="tab-weekly" class="px-4 py-2 text-base font-bold text-slate-500 hover:text-slate-300 transition-colors">Weekly (ì¤€ë¹„ì¤‘)</button>
        </div>

        <section id="task-list" class="space-y-0 pb-10">
            </section>
    </div>

    <script>
        class TaskManager {
            constructor() {
                this.storageKey = 'endfield_tasks_v3'; 
                this.resetHour = 5; 
                this.tasks = []; 
                this.currentTab = 'daily';
                this.sortable = null;
                this.state = this.loadState();
                
                this.init();
            }

            async init() {
                await this.loadData();
                this.checkReset();
                this.render();
            }

            async loadData() {
                try {
                    const response = await fetch('tasks.json');
                    this.tasks = await response.json();
                } catch (error) {
                    console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                    document.getElementById('task-list').innerHTML = `<div class="text-center p-10 text-slate-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>tasks.json íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
                }
            }

            loadState() {
                const saved = localStorage.getItem(this.storageKey);
                return saved ? JSON.parse(saved) : { 
                    lastLogin: Date.now(), 
                    completed: {},
                    order: { daily: [], weekly: [] } 
                };
            }

            saveState() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.state));
                this.render();
            }

            saveStateSilent() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.state));
                this.updateProgress();
            }

            checkReset() {
                const now = new Date();
                const last = new Date(this.state.lastLogin);
                const getGameDate = (date) => {
                    const adjusted = new Date(date);
                    adjusted.setHours(adjusted.getHours() - this.resetHour);
                    return adjusted.toDateString();
                };

                if (getGameDate(now) !== getGameDate(last)) {
                    this.state.completed = {};
                    console.log("ğŸ“… ìƒˆë²½ 5ì‹œê°€ ì§€ë‚˜ ìˆ™ì œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                this.state.lastLogin = now.getTime();
                localStorage.setItem(this.storageKey, JSON.stringify(this.state));
            }

            toggleTask(id) {
                if (this.state.completed[id]) { delete this.state.completed[id]; } 
                else { this.state.completed[id] = true; }
                this.saveState();
            }

            forceReset() {
                if(!confirm('ì˜¤ëŠ˜ì˜ ì™„ë£Œ ë‚´ì—­ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                this.state.completed = {};
                this.saveState();
            }

            resetOrder() {
                if(!confirm('ìˆœì„œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê² ìŠµë‹ˆê¹Œ?')) return;
                this.state.order[this.currentTab] = [];
                this.saveState();
            }

            switchTab(type) {
                if(type === 'weekly') { alert('ì£¼ê°„ í€˜ìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.'); return; }
                this.currentTab = type;
                this.render();
            }

            initSortable() {
                const el = document.getElementById('task-list');
                
                if (this.sortable) this.sortable.destroy();

                this.sortable = new Sortable(el, {
                    handle: '.drag-handle',
                    animation: 200,
                    ghostClass: 'sortable-ghost',
                    filter: '.section-header',
                    
                    scroll: true, 
                    scrollSensitivity: 100, 
                    scrollSpeed: 20,       
                    forceFallback: true,    
                    fallbackClass: 'sortable-fallback', 
                    
                    onEnd: () => {
                        this.saveCurrentOrder();
                        this.render(); 
                    }
                });
            }

            saveCurrentOrder() {
                const list = document.getElementById('task-list');
                const items = list.querySelectorAll('.task-item');
                const newOrder = Array.from(items).map(item => item.dataset.id);
                
                if (!this.state.order) this.state.order = { daily: [], weekly: [] };
                this.state.order[this.currentTab] = newOrder;
                
                this.saveStateSilent();
            }

            render() {
                if (this.tasks.length === 0) return;

                const listEl = document.getElementById('task-list');
                const progressTextEl = document.getElementById('progress-text');
                const progressBarEl = document.getElementById('progress-bar');
                const lastTimeEl = document.getElementById('last-reset-time');

                listEl.innerHTML = '';

                let currentTasks = this.tasks.filter(t => t.type === this.currentTab);

                const savedOrder = this.state.order?.[this.currentTab] || [];
                
                if (savedOrder.length > 0) {
                    const orderMap = new Map(savedOrder.map((id, index) => [id, index]));
                    currentTasks.sort((a, b) => {
                        const indexA = orderMap.has(a.id) ? orderMap.get(a.id) : 9999;
                        const indexB = orderMap.has(b.id) ? orderMap.get(b.id) : 9999;
                        return indexA - indexB;
                    });
                } else {
                    currentTasks.sort((a, b) => (a.default_order || 0) - (b.default_order || 0));
                }
                
                let lastAccess = ""; 

                currentTasks.forEach((task, index) => {
                    const isDone = this.state.completed[task.id] || false;

                    if (task.access !== lastAccess) {
                        const headerHtml = `
                            <div class="section-header sticky top-[200px] z-30 py-4 bg-slate-950/95 backdrop-blur-sm -mx-2 px-2 mt-2 border-b border-white/5 select-none pointer-events-none">
                                <h3 class="text-emerald-400 text-base font-bold flex items-center gap-2">
                                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                    ${task.access}
                                </h3>
                            </div>
                        `;
                        listEl.insertAdjacentHTML('beforeend', headerHtml);
                        lastAccess = task.access;
                    }

                    const tagsHtml = task.tags.map(tag => 
                        `<span class="text-xs font-bold text-slate-400 bg-slate-800 border border-slate-700 px-2 py-1 rounded">${tag}</span>`
                    ).join('');

                    const itemHtml = `
                        <div class="task-item group relative pl-4 py-3 ${isDone ? 'completed' : ''}" data-id="${task.id}">
                            
                            <div class="glass-panel p-5 rounded-2xl flex items-center gap-5 transition-all duration-200 group-hover:border-emerald-500/30 group-hover:bg-slate-800/60">
                                
                                <div class="relative shrink-0 cursor-pointer" onclick="taskManager.toggleTask('${task.id}')">
                                    <input type="checkbox" class="task-checkbox appearance-none absolute w-full h-full cursor-pointer z-10" ${isDone ? 'checked' : ''}>
                                    <div class="w-7 h-7 border-2 border-slate-600 rounded-lg flex items-center justify-center transition-all bg-slate-900">
                                        <svg class="w-5 h-5 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                    </div>
                                </div>

                                <div class="flex-1 min-w-0 task-content cursor-pointer" onclick="taskManager.toggleTask('${task.id}')">
                                    <div class="flex items-center justify-between mb-1.5">
                                        <h3 class="task-title text-xl font-bold text-white truncate">${task.title}</h3>
                                    </div>
                                    <p class="text-base text-slate-400 leading-snug mb-2.5">${task.desc}</p>
                                    <div class="flex flex-wrap gap-1.5 opacity-80">${tagsHtml}</div>
                                </div>

                                <div class="drag-handle relative shrink-0 w-10 h-10 flex items-center justify-center text-slate-600 hover:text-emerald-400 hover:bg-slate-700/50 rounded-xl transition-colors ml-auto">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                                </div>
                            </div>
                        </div>
                    `;
                    listEl.insertAdjacentHTML('beforeend', itemHtml);
                });

                this.updateProgress();
                
                const date = new Date(this.state.lastLogin);
                lastTimeEl.innerText = `ìµœê·¼ ë™ê¸°í™”: ${date.toLocaleString()}`;

                this.initSortable();
            }

            updateProgress() {
                const currentTasks = this.tasks.filter(t => t.type === this.currentTab);
                let doneCount = 0;
                currentTasks.forEach(t => {
                    if (this.state.completed[t.id]) doneCount++;
                });

                const percentage = currentTasks.length === 0 ? 0 : Math.round((doneCount / currentTasks.length) * 100);
                document.getElementById('progress-text').innerText = percentage;
                document.getElementById('progress-bar').style.width = `${percentage}%`;
            }
        }

        const taskManager = new TaskManager();

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                taskManager.checkReset();
            }
        });
    </script>
</body>
</html>