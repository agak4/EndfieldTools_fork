<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì—”ë“œí•„ë“œ ìˆ™ì œ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .sticky-panel { background: #0f172a; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        
        .task-checkbox:checked + div { background-color: #10b981; border-color: #10b981; }
        .task-checkbox:checked + div svg { display: block; }
        
        .task-item.completed .glass-panel { background: rgba(15, 23, 42, 0.6); }
        .task-item.completed .task-content { opacity: 0.5; text-decoration: line-through; color: #94a3b8; }
        
        /* ë“œë˜ê·¸ í•¸ë“¤ */
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; color: #34d399; }
        
        .sortable-ghost { opacity: 0.3; background: #334155; border-radius: 1rem; }
        .sortable-fallback { opacity: 1 !important; transform: scale(1.02); z-index: 9999; pointer-events: none; }
        .sortable-fallback .glass-panel { background: #1e293b; border-color: #10b981; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5); }

        .progress-bar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* [ìˆ˜ì •ë¨] ì“°ë ˆê¸°í†µ ìŠ¤íƒ€ì¼: í‰ì†Œì—” í„°ì¹˜ ë¶ˆê°€(none) -> í™œì„±í™” ì‹œ í„°ì¹˜ ê°€ëŠ¥(auto) */
        #trash-zone {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none; /* í‰ì†Œì—ëŠ” í´ë¦­ í†µê³¼ (ë²„ê·¸ ìˆ˜ì • í•µì‹¬) */
            /* ì€ì€í•œ ë¶‰ì€ ë¹› ê·¸ë¼ë°ì´ì…˜ */
            background: linear-gradient(to right, rgba(220, 38, 38, 0.5) 0%, rgba(220, 38, 38, 0.05) 70%, transparent 100%);
        }
        #trash-zone.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto; /* í™œì„±í™” ë˜ë©´ ë“œë ê°€ëŠ¥í•˜ê²Œ ë³€ê²½ */
        }
        #trash-zone .sortable-ghost { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 via-slate-950 to-black selection:bg-blue-500 selection:text-white relative text-base overflow-x-hidden">
    
    <nav class="flex justify-center gap-2 p-3 bg-slate-900/90 backdrop-blur-md border-b border-white/5 sticky top-0 z-50">
        <a href="index.html" class="px-5 py-2.5 rounded-xl text-sm md:text-base font-bold transition-all bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white">
            ğŸ§® ê¸°ì§ˆ ê³„ì‚°ê¸°
        </a>
        <a href="todo.html" class="px-5 py-2.5 rounded-xl text-sm md:text-base font-bold transition-all bg-emerald-600 text-white shadow-lg scale-105">
            ğŸ“ ìˆ™ì œ ê´€ë¦¬
        </a>
    </nav>

    <div class="max-w-3xl mx-auto space-y-4 md:space-y-6 pb-24 mt-4 md:mt-6 px-3 md:px-8">
        
        <section class="sticky top-20 z-40 transition-all duration-300">
            <div class="sticky-panel rounded-2xl md:rounded-3xl p-4 md:p-6 relative overflow-hidden">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h2 class="text-lg md:text-2xl font-bold text-white flex items-center gap-2">
                            <span class="w-1.5 h-5 md:w-2 md:h-6 bg-emerald-500 rounded-full"></span> ì¼ì¼ ì—…ë¬´ ë³´ê³ 
                        </h2>
                        <p class="text-xs md:text-sm text-slate-400 mt-0.5">ë§¤ì¼ ìƒˆë²½ 5ì‹œ ì´ˆê¸°í™”</p>
                    </div>
                    <span class="text-3xl md:text-4xl font-black text-emerald-400"><span id="progress-text">0</span>%</span>
                </div>
                
                <div class="w-full bg-slate-800/50 rounded-full h-3 md:h-4 overflow-hidden mb-4 border border-slate-700/50">
                    <div id="progress-bar" class="progress-bar bg-gradient-to-r from-emerald-500 to-cyan-500 h-3 md:h-4 rounded-full w-0 shadow-[0_0_10px_#10b981]"></div>
                </div>
                
                <div class="flex flex-wrap justify-between items-center border-t border-white/10 pt-3 gap-2">
                    <div class="flex gap-2">
                        <button id="btn-toggle-completed" onclick="taskManager.toggleHideCompleted()" class="px-3 py-2 rounded-lg bg-emerald-900/30 text-xs md:text-sm font-bold text-emerald-400 border border-emerald-700/50 hover:bg-emerald-800/50 transition-colors flex items-center gap-1.5">
                            <span>ğŸ‘ï¸</span> <span id="text-toggle-completed">ì™„ë£Œ ìˆ¨ê¸°ê¸°</span>
                        </button>
                        <button onclick="taskManager.openHiddenManager()" class="px-3 py-2 rounded-lg bg-slate-800 text-xs md:text-sm font-bold text-slate-400 border border-slate-600 hover:bg-slate-700 hover:text-white transition-colors flex items-center gap-1.5">
                            âš™ï¸ ì œì™¸ ê´€ë¦¬
                        </button>
                    </div>

                    <div class="flex gap-2 ml-auto">
                        <button onclick="taskManager.resetOrder()" class="px-3 py-2 rounded-lg bg-slate-800 text-xs md:text-sm font-bold text-slate-300 border border-slate-600 hover:bg-slate-700 hover:text-white transition-colors">
                            â†º ìˆœì„œ
                        </button>
                        <button onclick="taskManager.forceReset()" class="px-3 py-2 rounded-lg bg-slate-800 text-xs md:text-sm font-bold text-red-400 border border-slate-600 hover:bg-slate-700 hover:text-red-300 transition-colors">
                            âœ– ë¦¬ì…‹
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div class="flex gap-4 border-b border-slate-700/50 pb-1 px-1">
            <button onclick="taskManager.switchTab('daily')" id="tab-daily" class="px-3 py-2 text-sm md:text-base font-bold text-emerald-400 border-b-2 border-emerald-500 transition-colors">Daily</button>
            <button onclick="taskManager.switchTab('weekly')" id="tab-weekly" class="px-3 py-2 text-sm md:text-base font-bold text-slate-500 hover:text-slate-300 transition-colors">Weekly (ì¤€ë¹„ì¤‘)</button>
        </div>

        <section id="task-list" class="space-y-0 pb-10 min-h-[200px]">
            </section>
        
        <p class="text-center text-[10px] text-slate-600 pb-8" id="last-reset-time">ë™ê¸°í™” ì¤‘...</p>
    </div>

    <div id="trash-zone" class="fixed left-0 top-0 bottom-0 w-32 z-[100] flex flex-col justify-center items-start pl-6">
        <div class="text-5xl animate-pulse drop-shadow-[0_0_10px_rgba(220,38,38,0.8)]">ğŸ—‘ï¸</div>
        <span class="text-red-200 font-bold text-sm mt-2 leading-tight drop-shadow-md">ì—¬ê¸°ì—<br>ë²„ë¦¬ê¸°</span>
    </div>

    <div id="hidden-modal-backdrop" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[110] hidden flex items-center justify-center p-4 transition-opacity duration-200" onclick="taskManager.closeHiddenManager()">
        <div class="bg-slate-900 border border-slate-700 rounded-3xl w-full max-w-lg max-h-[80vh] flex flex-col shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-5 border-b border-slate-800 bg-slate-800/50 rounded-t-3xl">
                <h2 class="text-lg md:text-xl font-bold text-white">ì œì™¸ëœ í•­ëª© ê´€ë¦¬</h2>
                <button onclick="taskManager.closeHiddenManager()" class="text-slate-400 text-2xl leading-none hover:text-white">&times;</button>
            </div>
            <div id="hidden-list" class="overflow-y-auto p-5 space-y-3">
                </div>
            <div class="p-5 border-t border-slate-800 bg-slate-900 rounded-b-3xl">
                <button onclick="taskManager.closeHiddenManager()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl text-sm shadow-lg">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        class TaskManager {
            constructor() {
                this.storageKey = 'endfield_tasks_v3'; 
                this.resetHour = 5; 
                this.tasks = []; 
                this.currentTab = 'daily';
                this.sortable = null;
                this.trashSortable = null; 
                this.state = this.loadState();
                
                if (typeof this.state.hideCompleted === 'undefined') this.state.hideCompleted = false;
                if (typeof this.state.hiddenTasks === 'undefined') this.state.hiddenTasks = {}; 
                
                this.init();
            }

            async init() {
                await this.loadData();
                this.checkReset();
                this.render();
                this.initTrashZone(); 
            }

            async loadData() {
                try {
                    const response = await fetch('tasks.json');
                    this.tasks = await response.json();
                } catch (error) {
                    console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                    document.getElementById('task-list').innerHTML = `<div class="text-center p-10 text-slate-500">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>`;
                }
            }

            loadState() {
                const saved = localStorage.getItem(this.storageKey);
                return saved ? JSON.parse(saved) : { 
                    lastLogin: Date.now(), 
                    completed: {},
                    order: { daily: [], weekly: [] },
                    hideCompleted: false,
                    hiddenTasks: {} 
                };
            }

            saveState() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.state));
                this.render();
            }

            saveStateSilent() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.state));
                this.updateProgress();
            }

            checkReset() {
                const now = new Date();
                const last = new Date(this.state.lastLogin);
                const getGameDate = (date) => {
                    const adjusted = new Date(date);
                    adjusted.setHours(adjusted.getHours() - this.resetHour);
                    return adjusted.toDateString();
                };

                if (getGameDate(now) !== getGameDate(last)) {
                    this.state.completed = {};
                    console.log("ğŸ“… ìˆ™ì œ ì´ˆê¸°í™”");
                }
                this.state.lastLogin = now.getTime();
                localStorage.setItem(this.storageKey, JSON.stringify(this.state));
            }

            toggleTask(id) {
                if (this.state.completed[id]) { delete this.state.completed[id]; } 
                else { this.state.completed[id] = true; }
                this.saveState();
            }

            toggleHideCompleted() {
                this.state.hideCompleted = !this.state.hideCompleted;
                this.saveState();
            }

            hideTask(id) {
                this.state.hiddenTasks[id] = true;
                this.saveState();
            }

            restoreTask(id) {
                delete this.state.hiddenTasks[id];
                this.saveState();
                this.openHiddenManager(); 
            }

            openHiddenManager() {
                const modal = document.getElementById('hidden-modal-backdrop');
                const list = document.getElementById('hidden-list');
                const hiddenItems = this.tasks.filter(t => this.state.hiddenTasks[t.id]);

                if (hiddenItems.length === 0) {
                    list.innerHTML = `<div class="text-center text-slate-500 py-8 text-sm">ì œì™¸ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                } else {
                    list.innerHTML = hiddenItems.map(task => `
                        <div class="flex items-center justify-between bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-200 font-bold text-sm truncate mr-4">${task.title}</span>
                            <button onclick="taskManager.restoreTask('${task.id}')" class="text-xs font-bold text-emerald-400 border border-emerald-500/30 bg-emerald-900/20 px-3 py-1.5 rounded-lg hover:bg-emerald-900/50 whitespace-nowrap">ë³µêµ¬</button>
                        </div>
                    `).join('');
                }
                modal.classList.remove('hidden');
            }

            closeHiddenManager() {
                document.getElementById('hidden-modal-backdrop').classList.add('hidden');
            }

            forceReset() {
                if(!confirm('ì™„ë£Œ ë‚´ì—­ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                this.state.completed = {};
                this.saveState();
            }

            resetOrder() {
                if(!confirm('ìˆœì„œë¥¼ ë˜ëŒë¦¬ê² ìŠµë‹ˆê¹Œ?')) return;
                this.state.order[this.currentTab] = [];
                this.saveState();
            }

            switchTab(type) {
                if(type === 'weekly') { alert('ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.'); return; }
                this.currentTab = type;
                this.render();
            }

            initTrashZone() {
                const trashEl = document.getElementById('trash-zone');
                
                this.trashSortable = new Sortable(trashEl, {
                    group: 'tasks',
                    animation: 150,
                    ghostClass: 'hidden',
                    onAdd: (evt) => {
                        // [ë²„ê·¸ ìˆ˜ì •] ë“œë¡­ ì¦‰ì‹œ ë‹«ê¸°
                        document.getElementById('trash-zone').classList.remove('active');
                        
                        const id = evt.item.dataset.id;
                        this.hideTask(id);
                        evt.item.remove();
                        if (navigator.vibrate) navigator.vibrate(50);
                    }
                });
            }

            initSortable() {
                const el = document.getElementById('task-list');
                if (this.sortable) this.sortable.destroy();

                this.sortable = new Sortable(el, {
                    group: 'tasks',
                    handle: '.drag-handle',
                    animation: 200,
                    ghostClass: 'sortable-ghost',
                    filter: '.section-header', 
                    scroll: true, 
                    scrollSensitivity: 100, 
                    scrollSpeed: 20,       
                    forceFallback: true,    
                    fallbackClass: 'sortable-fallback', 
                    
                    onStart: () => {
                        document.getElementById('trash-zone').classList.add('active');
                    },
                    onEnd: () => {
                        document.getElementById('trash-zone').classList.remove('active');
                        this.saveCurrentOrder();
                        this.render(); 
                    }
                });
            }

            saveCurrentOrder() {
                const list = document.getElementById('task-list');
                const items = list.querySelectorAll('.task-item');
                const newOrder = Array.from(items).map(item => item.dataset.id);
                
                if (!this.state.order) this.state.order = { daily: [], weekly: [] };
                this.state.order[this.currentTab] = newOrder; 
                this.saveStateSilent();
            }

            toggleDetail(event, id) {
                const card = event.currentTarget.closest('.task-item');
                const desc = card.querySelector('.task-desc');
                const tags = card.querySelector('.task-tags');
                
                if (desc.classList.contains('line-clamp-1')) {
                    desc.classList.remove('line-clamp-1');
                    tags.classList.remove('hidden'); 
                } else {
                    desc.classList.add('line-clamp-1');
                    tags.classList.add('hidden'); 
                }
            }

            render() {
                if (this.tasks.length === 0) return;

                const listEl = document.getElementById('task-list');
                const lastTimeEl = document.getElementById('last-reset-time');
                const btnText = document.getElementById('text-toggle-completed');
                const btnIcon = document.getElementById('btn-toggle-completed');
                
                if (this.state.hideCompleted) {
                    btnText.innerText = "ì™„ë£Œ ë³´ì´ê¸°";
                    btnIcon.classList.add('bg-emerald-800', 'text-white');
                    btnIcon.classList.remove('bg-emerald-900/30', 'text-emerald-400');
                } else {
                    btnText.innerText = "ì™„ë£Œ ìˆ¨ê¸°ê¸°";
                    btnIcon.classList.remove('bg-emerald-800', 'text-white');
                    btnIcon.classList.add('bg-emerald-900/30', 'text-emerald-400');
                }

                listEl.innerHTML = '';

                let currentTasks = this.tasks.filter(t => t.type === this.currentTab);
                const savedOrder = this.state.order?.[this.currentTab] || [];
                
                if (savedOrder.length > 0) {
                    const orderMap = new Map(savedOrder.map((id, index) => [id, index]));
                    currentTasks.sort((a, b) => {
                        const indexA = orderMap.has(a.id) ? orderMap.get(a.id) : 9999;
                        const indexB = orderMap.has(b.id) ? orderMap.get(b.id) : 9999;
                        return indexA - indexB;
                    });
                } else {
                    currentTasks.sort((a, b) => (a.default_order || 0) - (b.default_order || 0));
                }
                
                let lastAccess = ""; 
                let visibleCount = 0;

                currentTasks.forEach((task, index) => {
                    if (this.state.hiddenTasks && this.state.hiddenTasks[task.id]) return;

                    const isDone = this.state.completed[task.id] || false;
                    if (this.state.hideCompleted && isDone) return;
                    visibleCount++;

                    if (task.access !== lastAccess) {
                        const headerHtml = `
                            <div class="section-header sticky top-[220px] md:top-[240px] z-30 py-3 md:py-4 bg-slate-950/95 backdrop-blur-sm -mx-2 px-2 mt-2 border-b border-white/5 select-none pointer-events-none">
                                <h3 class="text-emerald-400 text-sm md:text-base font-bold flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 md:w-2 md:h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                    ${task.access}
                                </h3>
                            </div>
                        `;
                        listEl.insertAdjacentHTML('beforeend', headerHtml);
                        lastAccess = task.access;
                    }

                    const tagsHtml = task.tags.map(tag => 
                        `<span class="text-[10px] md:text-xs font-bold text-slate-400 bg-slate-800 border border-slate-700 px-1.5 py-0.5 md:px-2 md:py-1 rounded">${tag}</span>`
                    ).join('');

                    const itemHtml = `
                        <div class="task-item group relative pl-2 md:pl-4 py-2 ${isDone ? 'completed' : ''}" data-id="${task.id}">
                            
                            <div class="glass-panel p-3 md:p-5 rounded-xl md:rounded-2xl flex items-start gap-3 md:gap-5 transition-all duration-200 group-hover:border-emerald-500/30 group-hover:bg-slate-800/60 cursor-pointer" onclick="taskManager.toggleTask('${task.id}')">
                                
                                <div class="relative shrink-0 pt-1">
                                    <input type="checkbox" class="task-checkbox appearance-none absolute w-full h-full cursor-pointer z-10" ${isDone ? 'checked' : ''}>
                                    <div class="w-6 h-6 md:w-7 md:h-7 border-2 border-slate-600 rounded-lg flex items-center justify-center transition-all bg-slate-900">
                                        <svg class="w-4 h-4 md:w-5 md:h-5 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                    </div>
                                </div>

                                <div class="flex-1 min-w-0 task-content" onclick="taskManager.toggleDetail(event, '${task.id}'); event.stopPropagation();">
                                    <div class="flex items-center justify-between mb-0.5 md:mb-1.5">
                                        <h3 class="task-title text-base md:text-xl font-bold text-white truncate pr-2">${task.title}</h3>
                                    </div>
                                    <p class="task-desc text-sm md:text-base text-slate-400 leading-snug mb-1 md:mb-2.5 line-clamp-1 break-keep">${task.desc}</p>
                                    <div class="task-tags flex flex-wrap gap-1 md:gap-1.5 opacity-80 hidden md:flex">${tagsHtml}</div>
                                </div>

                                <div class="drag-handle relative shrink-0 w-8 h-8 md:w-10 md:h-10 flex items-center justify-center text-slate-600 hover:text-emerald-400 hover:bg-slate-700/50 rounded-xl transition-colors ml-auto self-center" onclick="event.stopPropagation()">
                                    <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                                </div>
                            </div>
                        </div>
                    `;
                    listEl.insertAdjacentHTML('beforeend', itemHtml);
                });

                if (visibleCount === 0) {
                    listEl.innerHTML = `
                        <div class="text-center py-20">
                            <p class="text-4xl mb-4">ğŸ‰</p>
                            <p class="text-base md:text-xl font-bold text-white">í‘œì‹œí•  ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤!</p>
                            <button onclick="taskManager.toggleHideCompleted()" class="mt-4 text-slate-400 underline text-xs md:text-sm">ì™„ë£Œ í•­ëª© í™•ì¸í•˜ê¸°</button>
                        </div>
                    `;
                }

                this.updateProgress();
                const date = new Date(this.state.lastLogin);
                lastTimeEl.innerText = `ìµœê·¼ ë™ê¸°í™”: ${date.toLocaleString()}`;
                this.initSortable();
            }

            updateProgress() {
                const currentTasks = this.tasks.filter(t => t.type === this.currentTab && !this.state.hiddenTasks[t.id]);
                let doneCount = 0;
                currentTasks.forEach(t => { if (this.state.completed[t.id]) doneCount++; });
                
                const percentage = currentTasks.length === 0 ? 0 : Math.round((doneCount / currentTasks.length) * 100);
                document.getElementById('progress-text').innerText = percentage;
                document.getElementById('progress-bar').style.width = `${percentage}%`;
            }
        }

        const taskManager = new TaskManager();
        document.addEventListener('visibilitychange', () => { if (!document.hidden) taskManager.checkReset(); });
    </script>
</body>
</html>